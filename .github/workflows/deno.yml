# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow will install Deno then run `deno lint` and `deno test`.
# For more information see: https://github.com/denoland/setup-deno

name: Deno

on:
  push:
    branches: ["main"]
    paths:
      - "supabase/**"
      - "tests/**"
      - "deno.json"
      - "deno.lock"
      - ".github/workflows/deno.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "supabase/**"
      - "tests/**"
      - "deno.json"
      - "deno.lock"
      - ".github/workflows/deno.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DENO_TLS_CA_STORE: system
      DENO_NO_UPDATE_CHECK: "1"

    steps:
      - name: Setup repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
          cache: deno
          cache-dependency-path: |
            deno.lock
            supabase/functions/telegram-bot/vendor/import_map.json

      - name: Run Deno CI checks
        run: deno task ci

      - name: Ensure working tree is clean
        run: |
          if [[ -n "$(git status --short)" ]]; then
            echo "Git working tree dirty after CI tasks."
            git status --short
            git diff --stat
            exit 1
          fi
