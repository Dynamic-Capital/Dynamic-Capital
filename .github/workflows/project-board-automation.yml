name: Project Board Automation

on:
  issues:
    types:
      - opened
      - labeled
      - closed
  pull_request:
    types:
      - opened
      - labeled
      - ready_for_review
      - review_requested
      - reopened
      - closed

permissions:
  contents: read
  issues: write
  pull-requests: write
  projects: write

jobs:
  update-project:
    if: ${{ vars.DAI_PROJECT_URL != '' }}
    runs-on: ubuntu-latest
    env:
      PROJECT_URL: ${{ vars.DAI_PROJECT_URL }}
      PROJECT_TOKEN: ${{ secrets.PROJECT_BOARD_TOKEN || secrets.GITHUB_TOKEN }}
    steps:
      - name: Move work item to Backlog
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: Backlog
          labeled: enhancement, ai, tokenomics, trading

      - name: Move issue to To Do when sprint label present
        if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'sprint')
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: To Do (Sprint)

      - name: Move pull request to To Do when sprint label present
        if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'sprint')
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: To Do (Sprint)

      - name: Move pull request to In Progress when opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: In Progress

      - name: Move pull request to In Progress when reopened
        if: github.event_name == 'pull_request' && github.event.action == 'reopened'
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: In Progress

      - name: Move pull request to Review when ready for review
        if: github.event_name == 'pull_request' && github.event.action == 'ready_for_review'
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: Review / Testing

      - name: Move pull request to Review when review requested
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: Review / Testing

      - name: Move issue to Done when closed
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: Done

      - name: Move pull request to Done when merged
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: actions/add-to-project@v0.4.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
          column: Done
