name: Dependency Security Scan
permissions:
  contents: read

on:
  pull_request:
    paths:
      - package.json
      - package-lock.json
      - .github/workflows/dependency-security-scan.yml
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup runtimes
        uses: ./.github/actions/setup-runtimes
        with:
          enable-node: "true"
          node-version: "20"
          node-cache: npm
          node-cache-dependency-path: |
            package-lock.json
            apps/*/package-lock.json

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --omit=dev --audit-level=high > audit-report.txt
          cat audit-report.txt

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: npm-audit-report
          path: audit-report.txt

      - name: Fail on vulnerabilities
        if: steps.audit.outcome == 'failure'
        run: |
          echo "::error::High-severity vulnerabilities detected. See audit-report.txt artifact for details."
          exit 1
