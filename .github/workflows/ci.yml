name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/cache@v3
        id: lint-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-lint-${{ hashFiles('package-lock.json') }}
      - run: npm ci
        if: steps.lint-node-modules.outputs.cache-hit != 'true'
      - run: npm run lint

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      - run: deno test -A supabase/functions/_tests

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      - run: deno test -A tests

  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint, unit-tests, integration-tests]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Deploy edge functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID
      - name: Deploy telegram-webhook with JWT disabled
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy telegram-webhook --no-verify-jwt --project-id $SUPABASE_PROJECT_ID
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/cache@v3
        id: staging-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-deploy-${{ hashFiles('package-lock.json') }}
      - run: npm ci
        if: steps.staging-node-modules.outputs.cache-hit != 'true'
      - name: Set Telegram webhook
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          SUPABASE_URL: https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co
        run: npx tsx scripts/set-telegram-webhook.ts
      - uses: actions/cache@v3
        with:
          path: apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json', 'apps/web/package.json') }}
      - run: npm run build
      - name: Verify Mini App bundle
        run: node scripts/assert-miniapp-bundle.mjs
      - name: Deploy Mini App
        run: echo "Deploy Mini App to staging"

  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Deploy edge functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.PROD_SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.PROD_SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID
      - name: Deploy telegram-webhook with JWT disabled
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.PROD_SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.PROD_SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy telegram-webhook --no-verify-jwt --project-id $SUPABASE_PROJECT_ID
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/cache@v3
        id: prod-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-deploy-${{ hashFiles('package-lock.json') }}
      - run: npm ci
        if: steps.prod-node-modules.outputs.cache-hit != 'true'
      - name: Set Telegram webhook
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.PROD_TELEGRAM_WEBHOOK_SECRET }}
          SUPABASE_URL: https://${{ secrets.PROD_SUPABASE_PROJECT_ID }}.supabase.co
        run: npx tsx scripts/set-telegram-webhook.ts
      - uses: actions/cache@v3
        with:
          path: apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json', 'apps/web/package.json') }}
      - run: npm run build
      - name: Verify Mini App bundle
        run: node scripts/assert-miniapp-bundle.mjs
      - name: Deploy Mini App
        run: echo "Deploy Mini App to production"
