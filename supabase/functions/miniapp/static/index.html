<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dynamic Capital VIP • Mini App</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b1220; --text:#f5f5f5; --muted:#708499; --card:#192230; --accent:#5288c1;
      --ok:#15a34a; --warn:#f59e0b; --err:#ef4444; --shadow:rgba(0,0,0,0.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:760px; margin:0 auto; padding:20px 16px}
    .card{
      background:var(--card);
      border-radius:16px; padding:16px; box-shadow:0 6px 24px var(--shadow);
    }
    h1{font-size:22px; margin:0 0 8px}
    p{margin:0 0 10px; color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:600;
      background:var(--accent); color:white; cursor:pointer;
      box-shadow:0 4px 14px var(--shadow);
    }
    .btn.secondary{background:#263244; color:#e5e7eb}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn); color:#111827}
    .btn.err{background:var(--err)}
    .kv{display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #223043}
    .kv:last-child{border-bottom:0}
    code{background:#101826; padding:2px 6px; border-radius:6px; color:#cbd5e1}
    .badge{display:inline-flex; align-items:center; gap:6px; font-size:13px}
    .dot{width:8px; height:8px; border-radius:50%}
    .ok .dot{background:var(--ok)}
    .warn .dot{background:var(--warn)}
    .err .dot{background:var(--err)}
    .muted{color:var(--muted)}
    .spacer{height:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="welcome">
      <h1>Dynamic Capital VIP</h1>
      <p>Welcome to the Telegram Mini App. You can open your dashboard, check backend status, and (optionally) verify <code>initData</code>.</p>
      <div class="row">
        <button class="btn" id="openDashboardBtn">Open Dashboard</button>
        <button class="btn secondary" id="checkBackendBtn">Check Backend</button>
        <button class="btn secondary" id="verifyInitBtn" title="Calls /verify-initdata if deployed">Verify initData</button>
      </div>
      <div class="spacer"></div>
      <div class="kv"><div>WebApp user</div><div><span id="userName" class="muted">—</span></div></div>
      <div class="kv"><div>Theme</div><div><span id="theme" class="muted">—</span></div></div>
      <div class="kv"><div>Mini App URL</div><div><code id="miniUrl">—</code></div></div>
    </div>

    <div class="spacer"></div>

    <div class="card" id="statusCard">
      <h1>Status</h1>
      <div id="statusList" class="muted">No checks yet.</div>
    </div>

    <div class="spacer"></div>

    <div class="card" id="note">
      <p class="muted">
        Tip: In production, the bot replies to <code>/start</code> with a WebApp button.
        Ensure the button URL is an HTTPS link to this page (e.g.
        <code>https://qeejuomcapbdlhnjqjcc.functions.supabase.co/miniapp/</code>).
      </p>
    </div>
  </div>

  <script>
    (function () {
      const tg = window.Telegram?.WebApp;
      const statusList = document.getElementById("statusList");
      const miniUrlEl = document.getElementById("miniUrl");
      const themeEl = document.getElementById("theme");
      const userNameEl = document.getElementById("userName");
      const openDashboardBtn = document.getElementById("openDashboardBtn");
      const checkBackendBtn = document.getElementById("checkBackendBtn");
      const verifyInitBtn = document.getElementById("verifyInitBtn");

      const BASE = location.origin; // e.g. https://<project>.functions.supabase.co
      const MINI = location.pathname.replace(/\/+$/, "").endsWith("/miniapp") ? location.origin + "/miniapp/" : (location.origin + "/miniapp/");
      miniUrlEl.textContent = MINI;

      function addLine(html, cls) {
        const line = document.createElement("div");
        if (cls) line.className = cls;
        line.innerHTML = html;
        statusList.appendChild(line);
      }

      // Telegram init & theme
      try {
        if (tg) {
          tg.ready();
          tg.expand?.();
          const uname = tg.initDataUnsafe?.user?.first_name || tg.initDataUnsafe?.user?.username || "Anonymous";
          userNameEl.textContent = uname;
          const scheme = tg.colorScheme || "dark";
          themeEl.textContent = scheme;

          // Optional: adapt palette to Telegram theme
          if (scheme === "light") {
            document.documentElement.style.setProperty("--bg", "#f5f7fb");
            document.documentElement.style.setProperty("--text", "#0f172a");
            document.documentElement.style.setProperty("--card", "#ffffff");
            document.documentElement.style.setProperty("--muted", "#475569");
          }
        } else {
          addLine(`<span class="badge warn"><span class="dot"></span>Not in Telegram WebView</span>`, "muted");
        }
      } catch (e) {
        addLine(`<span class="badge err"><span class="dot"></span>Telegram init error</span> <code>${String(e).slice(0,120)}</code>`);
      }

      // Buttons
      openDashboardBtn.addEventListener("click", () => {
        // Single-page demo: just scroll to status or show a toast
        tg?.HapticFeedback?.impactOccurred?.("medium");
        addLine(`<span class="badge ok"><span class="dot"></span>Dashboard opened</span> <span class="muted">(demo)</span>`);
      });

      checkBackendBtn.addEventListener("click", async () => {
        statusList.textContent = "";
        try {
          const r = await fetch(`${MINI}version`, { method: "GET" });
          addLine(`<span class="badge ok"><span class="dot"></span>/miniapp/version → ${r.status}</span>`);
          const j = await r.json().catch(()=>null);
          if (j) addLine(`<code>${JSON.stringify(j)}</code>`);
        } catch (e) {
          addLine(`<span class="badge err"><span class="dot"></span>version check failed</span> <code>${String(e).slice(0,120)}</code>`);
        }
      });

      verifyInitBtn.addEventListener("click", async () => {
        statusList.textContent = "";
        try {
          const payload = { initData: tg?.initData || "", user: tg?.initDataUnsafe?.user || null };
          const r = await fetch(`${BASE}/verify-initdata`, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
          });
          const isOk = r.ok;
          const j = await r.json().catch(()=>null);
          addLine(`<span class="badge ${isOk ? "ok" : "warn"}"><span class="dot"></span>verify-initdata → ${r.status}</span>`);
          if (j) addLine(`<code>${JSON.stringify(j)}</code>`);
        } catch (e) {
          addLine(`<span class="badge err"><span class="dot"></span>verify-initdata failed</span> <code>${String(e).slice(0,120)}</code>`);
        }
      });
    })();
  </script>
</body>
</html>
